<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=yes'>
    <title>File Uploader</title>
    <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh' crossorigin='anonymous'>
  </head>
  <body class='container'>
    <form method='post' enctype='multipart/form-data'>
      <div>
        <label for='file-input'>Choose file to upload (max 5MB):</label>
        <input name='file-input' multiple='false' type='file'>
      </div>
      <div>
        <label for='category-select'>Choose a category:</label>
        <select name='categories' id='category-select' required>
          <option value=''>--Please choose a category--</option>
          <option value='systemA'>systemA</option>
          <option value='systemB'>systemB</option>
          <option value='systemC'>systemC</option>
        </select>
      </div>
      <div class='file-validation-message'>
        <p>No files currently selected for upload</p>
      </div>
      <div>
        <button class='mt-1' disabled>Submit</button>
      </div>
      <div id='progress-message'></div>
    </form>
  </body>
  <script>
    var apiBaseUrl = 'https://vq1ptznzf8.execute-api.us-east-1.amazonaws.com/dev';
    var button = document.querySelector('button');
    var fileValidationMessage = document.querySelector('.file-validation-message');
    var form = document.querySelector('form');
    var input = document.querySelector('input');
    var select = document.querySelector('select');

    function checkFile() {
      if (input.files[0].size > 5000000) {
        return fileValidationMessage.innerHTML = `<p>File size of ${input.files[0].size} bytes exceeds 5MB limit</p>`;
      }

      fileValidationMessage.innerHTML = '';
      button.removeAttribute('disabled');
    }

    input.addEventListener('change', checkFile);
    form.onsubmit = handleSubmit;

    function handleSubmit(e) {
      e.preventDefault();
      var file = input.files[0];
      document.getElementById('progress-message').innerHTML = '<p>Uploading...</p>';
      fetch(`${apiBaseUrl}/requestUploadURL`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: file.name,
          type: file.type
        })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(json) {
        var fileReader = new FileReader();
        fileReader.addEventListener('loadend', function() {
          fetch(json.uploadURL, {
            method: 'PUT',
            body: new Blob([fileReader.result], { type: file.type })
          })
          .then(function(response) {
            if (!response.ok) {
              return document.getElementById('progress-message').innerHTML = '<p>Error uploading file</p>';
            }
          });
        });

        fileReader.readAsArrayBuffer(file);
      })
      .then(function() {
        var name = `${file.name.substr(0, file.name.lastIndexOf('.'))}.json`;
        fetch(`${apiBaseUrl}/requestUploadURL`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name,
            type: 'application/json'
          })
        })
        .then(function (response) {
          return response.json();
        })
        .then(function (json) {
          fetch(json.uploadURL, {
            method: 'PUT',
            body: new Blob([JSON.stringify({ 'category': select.value })], { type: 'application/json' })
          })
          .then(function (response) {
            if (!response.ok) {
              return document.getElementById('progress-message').innerHTML = '<p>Error uploading json file</p>';
            }

            document.getElementById('progress-message').innerHTML = '<p>File successfully uploaded!</p>';
          });
        });
      });
    };
  </script>
</html>
